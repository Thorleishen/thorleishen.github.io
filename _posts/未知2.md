---
layout: post
title: 'æœªçŸ¥'
categories: php
tags: php
author: thorleishen
---

* content
{:toc}
## å­¦ä¹ è·¯çº¿

https://plugins.zhile.io



## é‡åˆ°çš„é—®é¢˜

1. å‰åç«¯åŸŸåä¸åŒï¼Œå¯¼è‡´è¯·æ±‚æŠ¥é”™ä¸å…è®¸è·¨åŸŸ
2. cookieè·¨åŸŸä¼ é€’é—®é¢˜



#### é—®é¢˜ä¸€ï¼šä¸åŒåŸŸåè·¨åŸŸé—®é¢˜

- è·¨åŸŸè¯·æ±‚æµç¨‹

  ```
  1. æµè§ˆå™¨è¿›è¡Œè·¨åŸŸè¯·æ±‚ï¼Œé¦–æ¬¡ä¼šå‘é€optionsé¢„æ£€è¯·æ±‚è¯¢é—®æœåŠ¡ç«¯æ˜¯å¦å¯ä»¥è¿›è¡Œè·¨åŸŸï¼Œå¦‚æœæœåŠ¡ç«¯æœªè®¾ç½®optionså…è®¸è·¨åŸŸè¯·æ±‚ï¼Œåˆ™è¯·æ±‚APIä¼šæŠ¥è·¨åŸŸ
  
  2. optionsè¯·æ±‚æˆåŠŸåï¼Œå†æ¬¡è¯·æ±‚è¯¥API
  ```

- è·¨åŸŸé—®é¢˜è§£å†³åŠæ³•ï¼ˆnginxæœåŠ¡å™¨è®¾ç½®ï¼‰

  ```
  # nginx æœåŠ¡å™¨é…ç½®è®¾ç½®
  1. è®¾ç½®optionsé¢„æ£€å…è®¸è·¨åŸŸ
  if ($request_method = 'OPTIONS') {
          add_header 'Access-Control-Allow-Origin' '*';
          add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
          #
          # Custom headers and headers various browsers *should* be OK with but aren't
          #
          add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
          #
          # Tell client that this pre-flight info is valid for 20 days
          #
          add_header 'Access-Control-Max-Age' 1728000; # æŒ‡å®šé¢„æ£€è¯·æ±‚æœ‰æ•ˆæœŸã€åœ¨æ­¤æœŸé—´ä¸ç”¨å‘é€å¦ä¸€æ¡é¢„æ£€è¯·æ±‚
          add_header 'Content-Type' 'text/plain; charset=utf-8';
          add_header 'Content-Length' 0;
          return 204;
       }
  
  2. è®¾ç½®postã€getç­‰æ–¹æ³•å…è®¸è·¨åŸŸ
  if ($request_method = 'GET') {
          add_header 'Access-Control-Allow-Origin' '$http_origin';
          add_header 'Access-Control-Allow-Credentials' 'true';
          add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
          add_header 'Access-Control-Allow-Headers' 'Cookie,Set-Cookie,DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
          add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
       }
  æ³¨ï¼šåœ¨è®¾ç½®å…è®¸è·¨åŸŸè¯·æ±‚æ—¶ï¼ŒAccess-Control-Allow-Originå‚æ•°åœ¨è®¾ç½®ä¸º"*"å¯èƒ½è¿˜æ˜¯ä¸èƒ½è¿›è¡Œè·¨åŸŸè¯·æ±‚ï¼Œå¯ä»¥è®¾ç½®ä¸ºæŒ‡å®šçš„originåœ°å€ï¼Œæˆ–è€…é€šè¿‡$http_originè·å–è¯·æ±‚çš„åœ°å€
  ```



#### é—®é¢˜äºŒï¼šcookieè·¨åŸŸé—®é¢˜

- cookieè·¨åŸŸè§£é‡Š

  ```
  å®šä¹‰ï¼šcookieè·¨åŸŸä¸»è¦å’ŒåŸŸådomainæœ‰å…³ï¼Œå¦‚æœå‰ç«¯å’ŒæœåŠ¡ç«¯åŸŸåä¸ä¸€æ ·å°±ä¼šå‡ºç°cookieè·¨åŸŸé—®é¢˜
  
  åˆ†ç±»ï¼š1. ä¸åŒåŸŸåcookieè·¨åŸŸé—®é¢˜ï¼Œä¾‹å¦‚ï¼š1.abc.comã€2.def.comï¼›2.ä¸åŒå­åŸŸåä¹‹é—´çš„è·¨åŸŸé—®é¢˜ï¼Œä¾‹å¦‚1.abc.comã€2.abc.com
  ```

- cookieè·¨åŸŸé—®é¢˜è§£å†³åŠæ³•

  ```
  æ³¨ï¼šåœ¨åšcookieè·¨åŸŸé—®é¢˜æ—¶ï¼Œå‰ç«¯éœ€è¦æ˜¾ç¤ºçš„å…è®¸cookieè·¨åŸŸä¼ é€’ï¼Œå³å‰ç«¯éœ€è®¾ç½®xhrFields: {
                      withCredentials: true
                  },
  1. ä¸åŒåŸŸåè·¨åŸŸé—®é¢˜ï¼ˆnginxæœåŠ¡å™¨è®¾ç½®ï¼‰
  é€šè¿‡è®¾ç½®nginxæœåŠ¡å™¨çš„ä¸‰ä¸ªå‚æ•°ï¼š
  proxy_set_header Cookie $http_cookie; # è®¾ç½®cookieå‚æ•°
  proxy_cookie_domain "1.abc.com" "2.def.com"; # å°†åŸŸådomainä¸º1.abc.comçš„cookieåŸŸåè®¾ç½®ä¸º2.def.comã€å¯æ¥å—æ­£åˆ™ï¼Œå¦‚æœåŸŸåå‰æœ‰.ç¬¦å·ï¼Œå¯ä»¥ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œæ­¤æ—¶æœ€å¥½ç”¨å¼•å·æ‹¬èµ·æ¥
  proxy_cookie_path / /; # è®¾ç½®cookieå­˜å‚¨è·¯å¾„ã€å¦‚æœè·¯å¾„ä¸åŒï¼Œçœ‹ä¸åˆ°è®¾ç½®çš„cookie
  2. ä¸åŒå­åŸŸåcookieè·¨åŸŸé—®é¢˜(nginxæœåŠ¡å™¨è®¾ç½®)
  é€šè¿‡è®¾ç½®ä¸»åŸŸådomainå¯ä»¥è¿›è¡Œè·¨åŸŸï¼Œå¦‚1.abc.comã€2.abc.comï¼Œé€šè¿‡è®¾ç½®domainä¸º.abc.comå¯ä»¥åšåˆ°è·¨åŸŸï¼ˆæ³¨ï¼šæœ‰.ç¬¦å·ï¼‰
  nginxé…ç½®å’Œä¸Šåºç›¸åŒ
  ```



## æ€»ç»“

å¯¹äºnginxè·¨åŸŸé—®é¢˜ï¼Œä¸€èˆ¬éœ€è¦å‰åç«¯åè°ƒå®Œæˆï¼Œåç«¯æœåŠ¡å™¨å¯ä»¥é€šè¿‡é…ç½®ç›¸å…³å…è®¸è·¨åŸŸçš„å‚æ•°ï¼ˆè®¾ç½®request headerï¼‰ï¼Œå‡å°‘å‰ç«¯æ¯æ¬¡å‘é€è¯·æ±‚éƒ½éœ€è¦è®¾ç½®request headerå‚æ•°ğŸ˜„
